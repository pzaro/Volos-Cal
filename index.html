<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UniFlow Pro v3</title>
    
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    
    <style>
        :root { 
            --primary: #007aff; 
            --secondary: #5856d6;
            --bg: #f2f2f7; 
            --card: #ffffff;
        }

        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #1c1c1e; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h3 { margin: 0 0 15px 0; font-size: 14px; color: #8e8e93; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Library Section */
        .library-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #f9f9fb; padding: 12px; border-radius: 12px; margin-bottom: 8px;
            border: 1px solid #e5e5ea;
        }
        .btn-use { background: var(--primary); color: white; padding: 8px 16px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; }
        
        /* Inputs */
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        input, select { width: 100%; padding: 14px; border: 1px solid #d1d1d6; border-radius: 12px; font-size: 16px; box-sizing: border-box; background: #fff; }
        .full-width { grid-column: span 2; }
        
        /* Buttons */
        button.main-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 15px; font-size: 17px; font-weight: 700; margin-top: 15px; cursor: pointer; }
        button.secondary-btn { background: var(--secondary); margin-top: 10px; }
        button:active { opacity: 0.8; transform: scale(0.98); }

        #calendar { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .loader { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 25px; display: none; z-index: 1000; font-size: 13px; }

        @media (max-width: 600px) { .grid-inputs { grid-template-columns: 1fr; } }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div id="loader">ğŸ”„ Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚...</div>

<div class="app-wrapper">
    <div class="card no-print">
        <h3>1. Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î”ÏÎ±ÏƒÏ„Î·ÏÎ¹ÏŒÏ„Î·Ï„Î±Ï‚</h3>
        <div class="grid-inputs">
            <input type="text" id="lib_title" class="full-width" placeholder="ÎŒÎ½Î¿Î¼Î± (Ï€.Ï‡. ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ¬ Î™Î™)">
            <select id="lib_duration">
                <option value="60">Î”Î¹Î¬ÏÎºÎµÎ¹Î±: 1 ÏÏÎ±</option>
                <option value="120" selected>Î”Î¹Î¬ÏÎºÎµÎ¹Î±: 2 ÏÏÎµÏ‚</option>
                <option value="180">Î”Î¹Î¬ÏÎºÎµÎ¹Î±: 3 ÏÏÎµÏ‚</option>
            </select>
            <select id="lib_type">
                <option value="course">Î¤ÏÏ€Î¿Ï‚: ÎœÎ¬Î¸Î·Î¼Î±</option>
                <option value="study">Î¤ÏÏ€Î¿Ï‚: Î”Î¹Î¬Î²Î±ÏƒÎ¼Î±</option>
                <option value="gym">Î¤ÏÏ€Î¿Ï‚: Î“Ï…Î¼Î½Î±ÏƒÏ„Î®ÏÎ¹Î¿</option>
                <option value="fun">Î¤ÏÏ€Î¿Ï‚: ÎˆÎ¾Î¿Î´Î¿Ï‚</option>
            </select>
        </div>
        <button class="main-btn secondary-btn" onclick="addToLibrary()">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÏƒÏ„Î· Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·</button>
        
        <div id="course_library" style="margin-top:20px;">
            </div>
    </div>

    <div class="card no-print" id="scheduling_card" style="display:none; border: 2px solid var(--primary);">
        <h3>2. Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· ÏƒÏ„Î¿ Î ÏÏŒÎ³ÏÎ±Î¼Î¼Î±</h3>
        <div class="grid-inputs">
            <input type="text" id="active_title" class="full-width" readonly>
            <input type="datetime-local" id="active_start">
            <p style="font-size:12px; color:#666; margin:0;">Î”Î¹Î¬ÏÎºÎµÎ¹Î±: <span id="display_dur"></span> Î»ÎµÏ€Ï„Î¬</p>
        </div>
        <button class="main-btn" onclick="saveToCloud()">Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· & ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·</button>
        <button class="main-btn" style="background:#8e8e93; margin-top:5px;" onclick="cancelPlacement()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
    </div>

    <div class="card">
        <button class="main-btn" style="background:#34c759; margin-bottom:15px; margin-top:0;" onclick="window.print()">Î•Î¾Î±Î³Ï‰Î³Î® ÏƒÎµ PDF</button>
        <div id="calendar"></div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzhcjNGbkBOU_kdYIEpII7dZWYqY9Klew1is6myvhz98g7PnyapL0Drn3_pkX9JcWFC/exec';
    let calendar;
    let library = JSON.parse(localStorage.getItem('uni_library_v3')) || [];
    let selectedTask = null;

    document.addEventListener('DOMContentLoaded', function() {
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: window.innerWidth < 768 ? 'timeGridDay' : 'timeGridWeek',
            locale: 'el',
            allDaySlot: false,
            slotMinTime: '08:00:00',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,timeGridDay' },
            events: [],
            eventClick: function(info) { if(confirm("Î”Î¹Î±Î³ÏÎ±Ï†Î®;")) deleteEvent(info.event); },
            eventDidMount: function(info) {
                const colors = { course: '#007aff', study: '#5856d6', gym: '#34c759', fun: '#ff9500' };
                info.el.style.backgroundColor = colors[info.event.extendedProps.type] || '#8e8e93';
                info.el.style.border = 'none';
            }
        });
        calendar.render();
        renderLibrary();
        loadFromCloud();
    });

    // --- LOGIC Î’Î—ÎœÎ‘ 1 ---
    function addToLibrary() {
        const title = document.getElementById('lib_title').value;
        const dur = document.getElementById('lib_duration').value;
        const type = document.getElementById('lib_type').value;
        if(!title) return alert("Î”ÏÏƒÎµ Î­Î½Î± ÏŒÎ½Î¿Î¼Î±!");
        
        library.push({title, dur, type});
        localStorage.setItem('uni_library_v3', JSON.stringify(library));
        renderLibrary();
        document.getElementById('lib_title').value = "";
    }

    function renderLibrary() {
        const div = document.getElementById('course_library');
        div.innerHTML = library.length ? "" : "<p style='text-align:center; color:#999;'>Î— Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î±.</p>";
        library.forEach((item, index) => {
            div.innerHTML += `
                <div class="library-item">
                    <div>
                        <b style="display:block;">${item.title}</b>
                        <small>${item.dur} Î»ÎµÏ€Ï„Î¬</small>
                    </div>
                    <button class="btn-use" onclick="startPlacement(${index})">Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·</button>
                </div>`;
        });
    }

    // --- LOGIC Î’Î—ÎœÎ‘ 2 ---
    function startPlacement(index) {
        selectedTask = library[index];
        document.getElementById('scheduling_card').style.display = 'block';
        document.getElementById('active_title').value = selectedTask.title;
        document.getElementById('display_dur').innerText = selectedTask.dur;
        window.scrollTo({ top: document.getElementById('scheduling_card').offsetTop - 20, behavior: 'smooth' });
    }

    function cancelPlacement() {
        document.getElementById('scheduling_card').style.display = 'none';
        selectedTask = null;
    }

    async function saveToCloud() {
        const start = document.getElementById('active_start').value;
        if(!start) return alert("Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼Î­ÏÎ± ÎºÎ±Î¹ ÏÏÎ±!");

        const startTime = new Date(start);
        const endTime = new Date(startTime.getTime() + selectedTask.dur * 60000);
        
        toggleLoader(true);
        const data = { 
            action: 'insert', 
            title: selectedTask.title, 
            start: startTime.toISOString(), 
            end: endTime.toISOString(), 
            type: selectedTask.type 
        };

        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            calendar.addEvent({ title: data.title, start: startTime, end: endTime, extendedProps: { type: data.type } });
            alert("ÎšÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±!");
            cancelPlacement();
        } catch(e) { alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚."); }
        toggleLoader(false);
    }

    // --- CLOUD SYNC ---
    async function loadFromCloud() {
        toggleLoader(true);
        try {
            const response = await fetch(SCRIPT_URL);
            const data = await response.json();
            calendar.removeAllEvents();
            data.forEach((row) => {
                if (row[1] && row[1].toString().includes('T')) {
                    calendar.addEvent({ title: row[0], start: row[1], end: row[2], extendedProps: { type: row[3] } });
                }
            });
        } catch(e) { console.log("Empty Sheet"); }
        toggleLoader(false);
    }

    async function deleteEvent(event) {
        toggleLoader(true);
        const data = { action: 'delete', title: event.title, start: event.start.toISOString() };
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
        event.remove();
        toggleLoader(false);
    }

    function toggleLoader(s) { document.getElementById('loader').style.display = s ? 'block' : 'none'; }
</script>

</body>

</html>
